
. cap mkdir ./output/collapsed

. cap mkdir ./output/graphs

. 
. * Generates graphs for clinical monitoring measures
. local outcomes "asthma copd"

. local strata "monitoring /*exacerbation*/"

. local other "review /*exacerbation*/"

. forvalues i=1/2 {
  2.     local this_outcome :word `i' of `outcomes'
  3.     forvalues j=1/1 {
  4.         local this_strata :word `j' of `strata'
  5.         local this_other :word `j' of `other'
  6.     * Ethnicity
.     clear 
  7.     import delimited using "./output/measures/resp/measure_`this_outcome'_
> `this_strata'_ethnicity_rate.csv", numericcols(4)
  8.     * Take out measures where population is not within subgroup
.     tab has_`this_outcome' 
  9.     drop if has_`this_outcome'==0
 10.     drop has_`this_outcome' 
 11.     * Generate rate per 100,000
.     gen rate = value*100000 
 12.     * Format date
.     gen dateA = date(date, "YMD")
 13.     drop date
 14.     format dateA %dD/M/Y
 15.     tab dateA 
 16.     * reshape dataset so columns with rates for each ethnicity 
.     reshape wide value rate population `this_outcome'_`this_other', i(dateA) 
> j(ethnicity)
 17.     describe
 18.     * Labelling ethnicity variables
.     label var rate1 "White"
 19.     label var rate2 "Mixed"
 20.     label var rate3 "Asian"
 21.     label var rate4 "Black"
 22.     label var rate5 "Other"
 23. 
.     * Generate line graph
.     graph twoway line rate1 rate2 rate3 rate4 rate5 date, tlabel(01Jan2018(12
> 0)01Apr2022, angle(45) ///
>     format(%dM-CY) labsize(small)) ytitle("Rate per 100,000") xtitle("Date") 
> ylabel(#5, labsize(small) ///
>     angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(small
> ) title("Ethnic categories", ///
>     size(small))) graphregion(fcolor(white))
 24. 
. 
.     graph export ./output/graphs/line_resp_ethnic_`this_outcome'_`this_strata
> '.svg, as(svg) replace
 25.     
.     * Reviewer comments plotting first derivative i.e. difference between cur
> rent rate and previous months rate
.     forvalues i=1/5 {
 26.         sort dateA
 27.         gen first_derivative`i' = rate`i' - rate`i'[_n-1]
 28.     }
 29.     * Label variables 
.     label var first_derivative1 "White"
 30.     label var first_derivative2 "Mixed"
 31.     label var first_derivative3 "Asian"
 32.     label var first_derivative4 "Black"
 33.     label var first_derivative5 "Other"
 34.     * Plot this
.     graph twoway line first_derivative1 first_derivative2 first_derivative3 f
> irst_derivative4 first_derivative5 date, tlabel(01Jan2018(120)01Apr2022, angl
> e(45) ///
>     format(%dM-CY) labsize(small)) ytitle("Difference per 100,000") xtitle("D
> ate") ylabel(#5, labsize(small) ///
>     angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(small
> ) ///
>     title("Ethnic categories", size(small))) graphregion(fcolor(white))
 35. 
.     graph export ./output/graphs/line_resp_ethnic_`this_outcome'_`this_strata
> '_diff.svg, as(svg) replace
 36.     * Export data file for output checking 
.     export delimited using ./output/graphs/line_data_resp_`this_outcome'_`thi
> s_strata'_ethnic.csv
 37.     /* IMD
>     clear 
>     import delimited using "./output/measures/resp/measure_`this_outcome'_`th
> is_strata'_imd_rate.csv", numericcols(4)
>     * Take out measures where population is not within subgroup
>     tab has_`this_outcome' 
>     drop if has_`this_outcome'==0
>     drop has_`this_outcome'  
>     * Generate rate per 100,000
>     gen rate = value*100000 
>     * Format date
>     gen dateA = date(date, "YMD")
>     drop date
>     format dateA %dD/M/Y
>     tab dateA 
>     * reshape dataset so columns with rates for each ethnicity 
>     reshape wide value rate population `this_outcome'_`this_other', i(dateA) 
> j(imd)
>     describe
>     * Labelling ethnicity variables
>     label var rate1 "IMD - 1"
>     label var rate2 "IMD - 2"
>     label var rate3 "IMD - 3"
>     label var rate4 "IMD - 4"
>     label var rate5 "IMD - 5"
> 
>     * Generate line graph
>     graph twoway line rate1 rate2 rate3 rate4 rate5 date, tlabel(01Jan2018(12
> 0)01Apr2022, angle(45) ///
>     format(%dM-CY) labsize(small)) ytitle("Rate per 100,000") xtitle("Date") 
> ylabel(#5, labsize(small) ///
>     angle(0)) yscale(range(0) titlegap(*10)) xmtick(##6) legend(row(1) size(s
> mall) ///
>     title("IMD categories", size(small))) graphregion(fcolor(white))
> 
> 
>     graph export ./output/graphs/line_resp_imd_`this_outcome'_`this_strata'.s
> vg, as(svg) replace
>     */
.     }
 38. }
(6 vars, 500 obs)

 has_asthma |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        250       50.00       50.00
          1 |        250       50.00      100.00
------------+-----------------------------------
      Total |        500      100.00
(250 observations deleted)

      dateA |      Freq.     Percent        Cum.
------------+-----------------------------------
  01mar2018 |          5        2.00        2.00
  01apr2018 |          5        2.00        4.00
  01may2018 |          5        2.00        6.00
  01jun2018 |          5        2.00        8.00
  01jul2018 |          5        2.00       10.00
  01aug2018 |          5        2.00       12.00
  01sep2018 |          5        2.00       14.00
  01oct2018 |          5        2.00       16.00
  01nov2018 |          5        2.00       18.00
  01dec2018 |          5        2.00       20.00
  01jan2019 |          5        2.00       22.00
  01feb2019 |          5        2.00       24.00
  01mar2019 |          5        2.00       26.00
  01apr2019 |          5        2.00       28.00
  01may2019 |          5        2.00       30.00
  01jun2019 |          5        2.00       32.00
  01jul2019 |          5        2.00       34.00
  01aug2019 |          5        2.00       36.00
  01sep2019 |          5        2.00       38.00
  01oct2019 |          5        2.00       40.00
  01nov2019 |          5        2.00       42.00
  01dec2019 |          5        2.00       44.00
  01jan2020 |          5        2.00       46.00
  01feb2020 |          5        2.00       48.00
  01mar2020 |          5        2.00       50.00
  01apr2020 |          5        2.00       52.00
  01may2020 |          5        2.00       54.00
  01jun2020 |          5        2.00       56.00
  01jul2020 |          5        2.00       58.00
  01aug2020 |          5        2.00       60.00
  01sep2020 |          5        2.00       62.00
  01oct2020 |          5        2.00       64.00
  01nov2020 |          5        2.00       66.00
  01dec2020 |          5        2.00       68.00
  01jan2021 |          5        2.00       70.00
  01feb2021 |          5        2.00       72.00
  01mar2021 |          5        2.00       74.00
  01apr2021 |          5        2.00       76.00
  01may2021 |          5        2.00       78.00
  01jun2021 |          5        2.00       80.00
  01jul2021 |          5        2.00       82.00
  01aug2021 |          5        2.00       84.00
  01sep2021 |          5        2.00       86.00
  01oct2021 |          5        2.00       88.00
  01nov2021 |          5        2.00       90.00
  01dec2021 |          5        2.00       92.00
  01jan2022 |          5        2.00       94.00
  01feb2022 |          5        2.00       96.00
  01mar2022 |          5        2.00       98.00
  01apr2022 |          5        2.00      100.00
------------+-----------------------------------
      Total |        250      100.00
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      250   ->      50
Number of variables                   6   ->      21
j variable (5 values)         ethnicity   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                   rate   ->   rate1 rate2 ... rate5
                             population   ->   population1 population2 ... popu
> lation5
                          asthma_review   ->   asthma_review1 asthma_review2 ..
> . asthma_review5
-----------------------------------------------------------------------------

Contains data
  obs:            50                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
asthma_review1  byte    %8.0g                 1 asthma_review
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
rate1           float   %9.0g                 1 rate
asthma_review2  byte    %8.0g                 2 asthma_review
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
rate2           float   %9.0g                 2 rate
asthma_review3  byte    %8.0g                 3 asthma_review
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
rate3           float   %9.0g                 3 rate
asthma_review4  byte    %8.0g                 4 asthma_review
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
rate4           float   %9.0g                 4 rate
asthma_review5  byte    %8.0g                 5 asthma_review
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
rate5           float   %9.0g                 5 rate
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_resp_ethnic_asthma_monitoring.svg not found)
(file ./output/graphs/line_resp_ethnic_asthma_monitoring.svg written in SVG for
> mat)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_resp_ethnic_asthma_monitoring_diff.svg not fou
> nd)
(file ./output/graphs/line_resp_ethnic_asthma_monitoring_diff.svg written in SV
> G format)
file ./output/graphs/line_data_resp_asthma_monitoring_ethnic.csv saved
(6 vars, 500 obs)

   has_copd |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        250       50.00       50.00
          1 |        250       50.00      100.00
------------+-----------------------------------
      Total |        500      100.00
(250 observations deleted)

      dateA |      Freq.     Percent        Cum.
------------+-----------------------------------
  01mar2018 |          5        2.00        2.00
  01apr2018 |          5        2.00        4.00
  01may2018 |          5        2.00        6.00
  01jun2018 |          5        2.00        8.00
  01jul2018 |          5        2.00       10.00
  01aug2018 |          5        2.00       12.00
  01sep2018 |          5        2.00       14.00
  01oct2018 |          5        2.00       16.00
  01nov2018 |          5        2.00       18.00
  01dec2018 |          5        2.00       20.00
  01jan2019 |          5        2.00       22.00
  01feb2019 |          5        2.00       24.00
  01mar2019 |          5        2.00       26.00
  01apr2019 |          5        2.00       28.00
  01may2019 |          5        2.00       30.00
  01jun2019 |          5        2.00       32.00
  01jul2019 |          5        2.00       34.00
  01aug2019 |          5        2.00       36.00
  01sep2019 |          5        2.00       38.00
  01oct2019 |          5        2.00       40.00
  01nov2019 |          5        2.00       42.00
  01dec2019 |          5        2.00       44.00
  01jan2020 |          5        2.00       46.00
  01feb2020 |          5        2.00       48.00
  01mar2020 |          5        2.00       50.00
  01apr2020 |          5        2.00       52.00
  01may2020 |          5        2.00       54.00
  01jun2020 |          5        2.00       56.00
  01jul2020 |          5        2.00       58.00
  01aug2020 |          5        2.00       60.00
  01sep2020 |          5        2.00       62.00
  01oct2020 |          5        2.00       64.00
  01nov2020 |          5        2.00       66.00
  01dec2020 |          5        2.00       68.00
  01jan2021 |          5        2.00       70.00
  01feb2021 |          5        2.00       72.00
  01mar2021 |          5        2.00       74.00
  01apr2021 |          5        2.00       76.00
  01may2021 |          5        2.00       78.00
  01jun2021 |          5        2.00       80.00
  01jul2021 |          5        2.00       82.00
  01aug2021 |          5        2.00       84.00
  01sep2021 |          5        2.00       86.00
  01oct2021 |          5        2.00       88.00
  01nov2021 |          5        2.00       90.00
  01dec2021 |          5        2.00       92.00
  01jan2022 |          5        2.00       94.00
  01feb2022 |          5        2.00       96.00
  01mar2022 |          5        2.00       98.00
  01apr2022 |          5        2.00      100.00
------------+-----------------------------------
      Total |        250      100.00
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      250   ->      50
Number of variables                   6   ->      21
j variable (5 values)         ethnicity   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                   rate   ->   rate1 rate2 ... rate5
                             population   ->   population1 population2 ... popu
> lation5
                            copd_review   ->   copd_review1 copd_review2 ... co
> pd_review5
-----------------------------------------------------------------------------

Contains data
  obs:            50                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
copd_review1    byte    %8.0g                 1 copd_review
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
rate1           float   %9.0g                 1 rate
copd_review2    byte    %8.0g                 2 copd_review
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
rate2           float   %9.0g                 2 rate
copd_review3    byte    %8.0g                 3 copd_review
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
rate3           float   %9.0g                 3 rate
copd_review4    byte    %8.0g                 4 copd_review
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
rate4           float   %9.0g                 4 rate
copd_review5    byte    %8.0g                 5 copd_review
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
rate5           float   %9.0g                 5 rate
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_resp_ethnic_copd_monitoring.svg not found)
(file ./output/graphs/line_resp_ethnic_copd_monitoring.svg written in SVG forma
> t)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_resp_ethnic_copd_monitoring_diff.svg not found
> )
(file ./output/graphs/line_resp_ethnic_copd_monitoring_diff.svg written in SVG 
> format)
file ./output/graphs/line_data_resp_copd_monitoring_ethnic.csv saved

. 
. /* Adding three monthly intervals for asthma exacerbation for ethnicity
> * Ethnicity
>     clear 
>     import delimited using "./output/measures/resp/measure_asthma_exacerbatio
> n_ethnicity_rate.csv", numericcols(4)
>     * Generate rate per 100,000
>     gen rate = value*100000 
>     * Format date
>     gen dateA = date(date, "YMD")
>     drop date
>     format dateA %dD/M/Y
>     tab dateA 
>     * Collapse at 3 monthly intervals
>     gen quarter = qofd(dateA)
>     collapse (sum) value rate has_asthma asthma_exacerbation (min) dateA,  by
> (quarter ethnicity)
>     drop quarter
>     * Outputing file 
>     export delimited using ./output/measures/resp/collapse_measure_asthma_exa
> cerbation_ethnicity_rate.csv 
>     * reshape dataset so columns with rates for each ethnicity 
>     reshape wide value rate has_asthma asthma_exacerbation, i(dateA) j(ethnic
> ity)
>     describe
>     * Labelling ethnicity variables
>     label var rate1 "White"
>     label var rate2 "Mixed"
>     label var rate3 "Asian"
>     label var rate4 "Black"
>     label var rate5 "Other"
> 
>     * Generate line graph
>     graph twoway line rate1 rate2 rate3 rate4 rate5 dateA, xlabel(, angle(45)
>  format(%dM-CY)) ///
>     ytitle("Rate per 100,000") 
> 
>     graph export ./output/line_resp_ethnic_asthma_exacerbation_collapse.svg, 
> as(svg) replace

end of do-file

. . file open output using "/tmp/104_graphs_resp.do.5R6R.out", write text repla
> ce

. . file write output "success" 

. . file close output

. 
end of do-file


