
. cap mkdir ./output/tempdata

. cap mkdir ./output/tables

. * Reviewer comment: putting files together for each ethnic group reference ca
> tegory 
. forvalues j=1/5 {
  2.         import delimited using ./output/tables/anx_`j'_cox_models.txt, str
> ingcols(3) clear
  3.         tempfile tempfile
  4.         * Generate risk differences between waves for each ethnic group
.         * count to reorder
.         gen number = _n
  5.         preserve
  6.         * calculate by ethnic group, save as temporary file, then merge ba
> ck on
.         * First do white then loop through rest
.         keep if ethnic_group=="Other"
  7.         * Create variables with rate/HR to compare to
.         foreach var in rate unadj_hr p_adj_hr f_adj_hr {
  8.                 gen `var'_pre = `var' if period=="pre"
  9.                 replace `var'_pre = `var'_pre[_n-1] if `var'_pre==. & `var
> '_pre[_n-1]!=.
 10.         }
 11.         * Calculate incidence rate ratio
.         gen IRR_vs_pre = rate/rate_pre if period!="pre"
 12.         * Calculate incident rate difference
.         gen IRD_vs_pre = rate - rate_pre if period!="pre"
 13.         * Calculate hazard rate ratio for each HR
.         gen unadj_HRR_vs_pre = unadj_hr/unadj_hr_pre if period!="pre"
 14.         gen P_HRR_vs_pre = p_adj_hr/p_adj_hr_pre if period!="pre"
 15.         gen F_HRR_vs_pre = f_adj_hr/f_adj_hr_pre if period!="pre"
 16.         keep period ethnic_group IRR_vs_pre-F_HRR_vs_pre number
 17.         save `tempfile', replace
 18.         restore
 19. 
.         * Other ethnic group 
.         replace ethnic_group = "Asian" if ethnic_group=="South Asian"
 20.         foreach group in Mixed Black Asian White {
 21.                 * Generate risk differences between waves for each ethnic 
> group
.                 preserve
 22.                 keep if ethnic_group=="`group'"
 23.                 * calculate by ethnic group, save as temporary file, then 
> merge back on
.                 * First do white then loop through rest
.                 foreach var in rate unadj_hr p_adj_hr f_adj_hr {
 24.                         gen `var'_pre = `var' if period=="pre"
 25.                         replace `var'_pre = `var'_pre[_n-1] if `var'_pre==
> . & `var'_pre[_n-1]!=.
 26.                         }
 27.                 * Calculate incidence rate ratio
.                 gen IRR_vs_pre = rate/rate_pre if period!="pre"
 28.                 * Calculate incident rate difference
.                 gen IRD_vs_pre = rate - rate_pre if period!="pre"
 29.                 * Calculate hazard rate ratio for each HR
.                 gen unadj_HRR_vs_pre = unadj_hr/unadj_hr_pre if period!="pre"
 30.                 gen P_HRR_vs_pre = p_adj_hr/p_adj_hr_pre if period!="pre"
 31.                 gen F_HRR_vs_pre = f_adj_hr/f_adj_hr_pre if period!="pre"
 32.                 keep period ethnic_group IRR_vs_pre-F_HRR_vs_pre number 
 33.                 append using `tempfile'
 34.                 save `tempfile', replace
 35.                 sort number
 36.                 restore
 37.                 }
 38. 
.         merge 1:1 period ethnic_group using `tempfile'
 39.         gen group="Mental Health"
 40.         gen outcome="Anxiety"
 41.         save ./output/tables/all_cox_data_`j', replace
 42. 
.         * add mi back in when upload
.         local a "depress asthma copd dm_keto t1dm t2dm hf mi stroke vte"
 43.         local b "MH Respiratory Respiratory Diabetes Diabetes Diabetes Car
> diovascular_hfmi Cardiovascular_hfmi Cardiovascular Cardiovascular" 
 44.         forvalues i=1/9 {
 45.                 local outcome: word `i' of `a'
 46.                 local category: word `i' of `b'
 47. 
.                 import delimited using ./output/tables/`outcome'_`j'_cox_mode
> ls.txt, stringcols(3) clear
 48.                 tempfile tempfile
 49.                 * Generate risk differences between waves for each ethnic 
> group
.                 * count to reorder
.                 gen number = _n
 50.                 preserve
 51.                 * calculate by ethnic group, save as temporary file, then 
> merge back on
.                 * First do white then loop through rest
.                 keep if ethnic_group=="Other"
 52.                 * Create variable with rate to compare to
.                 foreach var in rate unadj_hr p_adj_hr f_adj_hr {
 53.                         gen `var'_pre = `var' if period=="pre"
 54.                         replace `var'_pre = `var'_pre[_n-1] if `var'_pre==
> . & `var'_pre[_n-1]!=.
 55.                         }
 56.                 * Calculate incidence rate ratio
.                 gen IRR_vs_pre = rate/rate_pre if period!="pre"
 57.                 * Calculate incident rate difference
.                 gen IRD_vs_pre = rate - rate_pre if period!="pre"
 58.                 * Calculate hazard rate ratio for each HR
.                 gen unadj_HRR_vs_pre = unadj_hr/unadj_hr_pre if period!="pre"
 59.                 gen P_HRR_vs_pre = p_adj_hr/p_adj_hr_pre if period!="pre"
 60.                 gen F_HRR_vs_pre = f_adj_hr/f_adj_hr_pre if period!="pre"
 61.                 keep period ethnic_group IRR_vs_pre-F_HRR_vs_pre number
 62.                 gen group = "`category'"
 63.                 gen outcome = "`outcome'"
 64.                 save `tempfile', replace
 65.                 restore
 66. 
.                 * Other ethnic group 
.                 replace ethnic_group = "Asian" if ethnic_group=="South Asian"
 67.                 foreach group in Mixed Black Asian White {
 68.                         * Generate risk differences between waves for each
>  ethnic group
.                         preserve
 69.                         * calculate by ethnic group, save as temporary fil
> e, then merge back on
.                         * First do white then loop through rest
.                         keep if ethnic_group=="`group'"
 70.                         foreach var in rate unadj_hr p_adj_hr f_adj_hr {
 71.                                 gen `var'_pre = `var' if period=="pre"
 72.                                 replace `var'_pre = `var'_pre[_n-1] if `va
> r'_pre==. & `var'_pre[_n-1]!=.
 73.                                 }
 74.                         * Calculate incidence rate ratio
.                         gen IRR_vs_pre = rate/rate_pre if period!="pre"
 75.                         * Calculate incident rate difference
.                         gen IRD_vs_pre = rate - rate_pre if period!="pre"
 76.                         * Calculate hazard rate ratio for each HR
.                         gen unadj_HRR_vs_pre = unadj_hr/unadj_hr_pre if perio
> d!="pre"
 77.                         gen P_HRR_vs_pre = p_adj_hr/p_adj_hr_pre if period
> !="pre"
 78.                         gen F_HRR_vs_pre = f_adj_hr/f_adj_hr_pre if period
> !="pre"
 79.                         keep period ethnic_group IRR_vs_pre-F_HRR_vs_pre n
> umber
 80.                         gen group = "`category'"
 81.                         gen outcome = "`outcome'"
 82.                         append using `tempfile'
 83.                         save `tempfile', replace
 84.                         sort number
 85.                         restore
 86.                         }
 87. 
.                 merge 1:1 period ethnic_group using `tempfile'
 88.                 append using ./output/tables/all_cox_data_`j'
 89.                 save ./output/tables/all_cox_data_`j', replace  
 90.                 
.         }
 91. 
.         replace denominator="redacted" if denominator=="redact"
 92.         gen ethnic_order = 1 if ethnic_group=="White"
 93.         replace ethnic_order=2 if ethnic_group=="Asian"
 94.         replace ethnic_order=3 if ethnic_group=="Black"
 95.         replace ethnic_order=4 if ethnic_group=="Mixed"
 96.         replace ethnic_order=5 if ethnic_group=="Other"
 97.         gen time_order=1 if period=="pre"
 98.         replace time_order=2 if period=="pandemic"
 99.         replace time_order=3 if period=="wave1"
100.         replace time_order=4 if period=="easing1"
101.         replace time_order=5 if period=="wave2"
102.         replace time_order=6 if period=="easing2"
103.         replace time_order=7 if period=="wave3"
104.         replace time_order=8 if period=="easing3"
105.         * Update period variable
.         gen period_n="Pre" if period=="pre"
106.         replace period_n="Pandemic" if period=="pandemic"
107.         replace period_n="Wave 1" if period=="wave1"
108.         replace period_n="Easing 1" if period=="easing1"
109.         replace period_n="Wave 2" if period=="wave2"
110.         replace period_n="Easing 2" if period=="easing2"
111.         replace period_n="Wave 3" if period=="wave3"
112.         replace period_n="Easing 3" if period=="easing3"
113.         drop period
114.         replace group= "Mental Health" if group == "MH"
115.         gen outcome_n = "Stroke" if outcome=="stroke"
116.         replace outcome_n = "VTE" if outcome=="vte"
117.         replace outcome_n = "Heart failure" if outcome=="hf"
118.         replace outcome_n = "MI" if outcome=="mi"
119.         replace outcome_n = "DKA" if outcome=="dm_keto"
120.         replace outcome_n = "T1 DM" if outcome=="t1dm"
121.         replace outcome_n = "T2 DM" if outcome=="t2dm"
122.         replace outcome_n = "Anxiety" if outcome=="Anxiety"
123.         replace outcome_n = "Depression" if outcome=="depress"
124.         replace outcome_n = "Asthma" if outcome=="asthma"
125.         replace outcome_n = "COPD" if outcome=="copd"
126.         drop outcome
127.         order group outcome_n period_n ethnic_group
128.         sort group outcome_n time_order ethnic_order
129.         drop time_order ethnic_order
130.         rename ethnic_group Ethnicity
131.         rename period_n Period
132.         rename group Group
133.         rename outcome_n Outcome
134.         rename denominator Denominator
135.         rename rate Rate
136.         rename f_adj_lci F_adj_lci
137.         rename f_adj_uci F_adj_uci
138.         rename f_adj_hr F_adj_hr
139.         rename p_adj_lci P_adj_lci
140.         rename p_adj_uci P_adj_uci
141.         rename p_adj_hr P_adj_hr
142.         drop v* number _merge
143.         * Export data for table including confidence intervals
.         export delimited using $savedir\all_cox_data_inc_ci_`j'.csv, replace
144.         * drop formated confidence intervals
.         drop unadj_ci p_adj_ci f_adj_ci
145.         save ./output/tables/all_cox_data_`j', replace
146.         export delimited using ./output/tables/all_cox_data_`j'.csv, repla
> ce
147.         }
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.000001 not found)
file /tmp/St00016.000001 saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000001 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000001 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000001 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000001 saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: file ./output/tables/all_cox_data_1.dta not found)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.000007 not found)
file /tmp/St00016.000007 saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000007 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000007 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000007 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000007 saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.00000d not found)
file /tmp/St00016.00000d saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000d saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000d saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000d saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000d saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable denominator was str1, now str6 to accommodate using data's
       values)
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.00000j not found)
file /tmp/St00016.00000j saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000j saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000j saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000j saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000j saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable denominator was str1, now str6 to accommodate using data's
       values)
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.00000p not found)
file /tmp/St00016.00000p saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000p saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000p saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000p saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000p saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable denominator was str1, now str6 to accommodate using data's
       values)
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.00000v not found)
file /tmp/St00016.00000v saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000v saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000v saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000v saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.00000v saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable denominator was str1, now str6 to accommodate using data's
       values)
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.000013 not found)
file /tmp/St00016.000013 saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000013 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000013 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000013 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000013 saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
(19 vars, 8 obs)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
(note: file /tmp/St00016.000019 not found)
file /tmp/St00016.000019 saved
(0 real changes made)
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000019 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000019 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000019 saved
(8 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(note: dataset contains 0 observations)
file /tmp/St00016.000019 saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             8
        from master                         8  (_merge==1)
        from using                          0  (_merge==2)

    matched                                 0  (_merge==3)
    -----------------------------------------
(note: variable group was str1, now str13 to accommodate using data's values)
(note: variable outcome was str1, now str7 to accommodate using data's
       values)
(label _merge already defined)
file ./output/tables/all_cox_data_1.dta saved
file ./output/tables/mi_1_cox_models.txt not found
r(601);

end of do-file
r(601);

end of do-file

r(601);


