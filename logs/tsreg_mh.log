
. cap mkdir ./output/time_series

. * Time series analysis CVD outcomes
. * Clinical monitoring: BP measurement
. * Hospital admissions: any code and primary code for MI, stroke, heart failur
> e and vte
. local a "bp_meas_mh depression_admission anxiety_admission smi_admission self
> _harm_admission eating_dis_admission ocd_admission" 

. forvalues i=1/1 {
  2.     local c: word `i' of `a' 
  3.         local b "ethnicity imd"
  4.         forvalues i=1/2 {
  5.         local d: word `i' of `b'
  6.                 import delimited "./output/measures/mh/measure_`c'_`d'_rat
> e.csv", numericcols(4) clear  //get csv
  7.         putexcel set ./output/time_series/tsreg_tables_mh, sheet(`c'_`d') 
> modify                        //open xlsx
  8.         * Drop records where ethnicity is missing - no missing IMD
.         drop if `d'==0 | `d'==.
  9.         drop if mh_subgroup==0
 10.         *Format time
.         gen temp_date=date(date, "YMD")
 11.         format temp_date %td
 12.         gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
 13.         gen month=mofd(temp_date)
 14.         format month %tm
 15.         *Define Seasons
.         gen season=4
 16.         replace season = 1 if inrange(month(temp_date),3,5)
 17.         replace season = 2 if inrange(month(temp_date),6,8)
 18.         replace season = 3 if inrange(month(temp_date),9,11)
 19.         label define seasonlab 1 "Spring" 2 "Summer" 3 "Autumn" 4 "Winter"
 20.         label values season seasonlab
 21.         drop temp_date
 22.         *Value to rate per 100k
.         gen rate = value*100000
 23.         *Run time series with EWH-robust SE and 1 Lag
.         tsset `d' month
 24.         newey rate i.`d'##i.postcovid i.season, lag(1) force
 25.         *Export results
.         putexcel E1=("Number of obs") G1=(e(N))
 26.         putexcel E2=("F") G2=(e(F))
 27.         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
 28.         matrix a = r(table)'
 29.         putexcel A6 = matrix(a), rownames
 30.         putexcel save
 31.         quietly margins `d'##postcovid
 32.         marginsplot
 33.         graph export ./output/time_series/margins_mh_`c'_`d'.svg, as(svg) 
> replace
 34.         import excel using ./output/time_series/tsreg_tables_mh.xlsx, shee
> t (`c'_`d') clear
 35.         export delimited using ./output/time_series/tsreg_mh_`c'_`d'.csv
 36.         }
 37.     }
(6 vars, 600 obs)
(100 observations deleted)
(250 observations deleted)
(70 real changes made)
(60 real changes made)
(60 real changes made)
(2 missing values generated)
       panel variable:  ethnicity (strongly balanced)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =        248
maximum lag: 1                                  F( 12,       235) =       2.69
                                                Prob > F          =     0.0020

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   ethnicity |
          2  |   1754.113   3691.157     0.48   0.635    -5517.872    9026.098
          3  |       -400   3627.632    -0.11   0.912    -7546.834    6746.834
          4  |   6820.635   3770.756     1.81   0.072    -608.1696    14249.44
          5  |   2590.476   3708.814     0.70   0.486    -4716.296    9897.248
             |
 1.postcovid |   2860.318   4087.297     0.70   0.485    -5192.107    10912.74
             |
   ethnicity#|
   postcovid |
        2 1  |  -10486.93   5098.261    -2.06   0.041    -20531.07   -442.7993
        3 1  |   3463.492    6593.48     0.53   0.600    -9526.389    16453.37
        4 1  |   -14106.3   5362.217    -2.63   0.009    -24670.45   -3542.138
        5 1  |  -2526.985   6476.166    -0.39   0.697    -15285.74    10231.77
             |
      season |
     Summer  |    3369.38   3202.367     1.05   0.294    -2939.635    9678.395
     Autumn  |  -982.4498   2363.468    -0.42   0.678    -5638.741    3673.842
     Winter  |  -3231.811   2264.605    -1.43   0.155    -7693.331     1229.71
             |
       _cons |   8345.629   3041.595     2.74   0.007     2353.351    14337.91
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved

  Variables that uniquely identify margins: ethnicity postcovid
(note: file ./output/time_series/margins_mh_bp_meas_mh_ethnicity.svg not found)
(file ./output/time_series/margins_mh_bp_meas_mh_ethnicity.svg written in SVG f
> ormat)
(10 vars, 27 obs)
file ./output/time_series/tsreg_mh_bp_meas_mh_ethnicity.csv saved
(6 vars, 700 obs)
(200 observations deleted)
(250 observations deleted)
(70 real changes made)
(60 real changes made)
(60 real changes made)
(5 missing values generated)
       panel variable:  imd (strongly balanced)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =        245
maximum lag: 1                                  F( 12,       232) =       1.30
                                                Prob > F          =     0.2184

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         imd |
          2  |   6796.995   3681.675     1.85   0.066    -456.7959    14050.79
          3  |   95.23828    3388.55     0.03   0.978    -6581.024    6771.501
          4  |   6733.334   4051.021     1.66   0.098    -1248.158    14714.83
          5  |   1395.238   2958.131     0.47   0.638    -4432.995    7223.471
             |
 1.postcovid |        300   3221.536     0.09   0.926    -6047.205    6647.205
             |
         imd#|
   postcovid |
        2 1  |  -7519.091   5405.051    -1.39   0.166    -18168.35    3130.167
        3 1  |   2954.587   6221.497     0.47   0.635    -9303.267    15212.44
        4 1  |  -8961.905    5285.55    -1.70   0.091    -19375.72    1451.907
        5 1  |   2771.428   5141.534     0.54   0.590    -7358.638    12901.49
             |
      season |
     Summer  |  -3062.833   2901.238    -1.06   0.292    -8778.973    2653.307
     Autumn  |  -4750.313    2950.52    -1.61   0.109    -10563.55    1062.925
     Winter  |   -6599.96   2816.622    -2.34   0.020    -12149.39   -1050.533
             |
       _cons |   10497.24   2806.722     3.74   0.000      4967.32    16027.16
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved
file ./output/time_series/tsreg_tables_mh.xlsx saved

  Variables that uniquely identify margins: imd postcovid
(note: file ./output/time_series/margins_mh_bp_meas_mh_imd.svg not found)
(file ./output/time_series/margins_mh_bp_meas_mh_imd.svg written in SVG format)
(10 vars, 27 obs)
file ./output/time_series/tsreg_mh_bp_meas_mh_imd.csv saved

. 
. /*local a "depression_primary_admission anxiety_primary_admission smi_primary
> _admission self_harm_primary_admission anxiety_emergency smi_emergency self_h
> arm_emergency"
> local b "depress_pri anxiety_pri smi_pri sh_pri anx_emergency smi_emergency s
> h_emergency"
> forvalues i=1/7 {
>         local c: word `i' of `a'
>     local d: word `i' of `b' 
>         local e "ethnicity imd"
>         forvalues i=1/2 {
>         local f: word `i' of `e'
>         import delimited "./output/measures/mh/measure_`c'_`f'_rate.csv", num
> ericcols(3) clear  //get csv
>         putexcel set ./output/time_series/tsreg_tables_mh, sheet(`d'_`f') mod
> ify                        //open xlsx
>         * Drop records where ethnicity is missing - no missing IMD
>         drop if `f'==0
>         *Format time
>         gen temp_date=date(date, "YMD")
>         format temp_date %td
>         gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
>         gen month=mofd(temp_date)
>         format month %tm
>         *Define Seasons
>         gen season=4
>         replace season = 1 if inrange(month(temp_date),3,5)
>         replace season = 2 if inrange(month(temp_date),6,8)
>         replace season = 3 if inrange(month(temp_date),9,11)
>         label define seasonlab 1 "Spring" 2 "Summer" 3 "Autumn" 4 "Winter"
>         label values season seasonlab
>         drop temp_date
>         *Value to rate per 100k
>         gen rate = value*100000
>         *Run time series with EWH-robust SE and 1 Lag
>         tsset `f' month
>         newey rate i.`f'##i.postcovid i.season, lag(1) force
>         *Export results
>         putexcel E1=("Number of obs") G1=(e(N))
>         putexcel E2=("F") G2=(e(F))
>         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
>         matrix a = r(table)'
>         putexcel A6 = matrix(a), rownames
>         putexcel save
>         quietly margins `f'##postcovid
>         marginsplot
>         graph export ./output/time_series/margins_mh_`d'_`f'.svg, as(svg) rep
> lace
>         import excel using ./output/time_series/tsreg_tables_mh.xlsx, sheet (
> `d'_`f') clear
>         export delimited using ./output/time_series/tsreg_mh_`d'_`f'.csv, rep
> lace
>         }
>     }
> */
. 
end of do-file

. . file open output using "/tmp/tmp.lQTfpYa5wB", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


