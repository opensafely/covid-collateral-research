
. cap mkdir ./output/graphs

. 
. /* Creating files for R survival curves plotting 5+ event steps
> foreach period in pre pandemic {
>     use ./output/prep_survival_`period', clear
>     describe
>     foreach outcome in stroke mi hf vte dm_keto t1dm t2dm depress anx copd as
> thma {
>         * Drop events that occur on index date
>         replace `outcome'_admit_date=. if `outcome'_admit_date==index_date
> 
>         /* Update study population for diabetes and respiratory outcomes
>         drop if diabetes_subgroup==0 & "`outcome'"== "dm_keto"
>         drop if has_t1_diabetes==0 & "`outcome'"=="t1dm"
>         drop if has_t2_diabetes==0 & "`outcome'"== "t2dm"
>         drop if has_asthma==0 & "`outcome'"== "asthma"
>         drop if has_copd==0 & "`outcome'"=="copd"*/
>         
>         * Cox model for each outcome category
>         * Generate flags and end dates for each outcome
>         gen `outcome'_admit=(`outcome'_admit_date!=.)
>         tab `outcome'_admit
>         gen `outcome'_end = end_date
>         replace `outcome'_end = `outcome'_admit_date if `outcome'_admit==1
> 
>         stset `outcome'_end, fail(`outcome'_admit) id(patient_id) enter(index
> _date) origin(index_date) 
>         keep patient_id _t _d _t0 
> 
>     }
>     save ./output/survival/survival__`period'.dta, replace
> }
> */
. * Page on time_varying splitting: https://stats.stackexchange.com/questions/1
> 12555/what-s-wrong-with-this-way-of-fitting-time-dependent-coefficients-in-a-
> cox-regre 
. * For outcomes where axis 0.99
. foreach period in pre pandemic /*wave1 easing1 wave2 easing2 wave3 easing3*/ 
> {
  2.     use ./output/prep_survival_`period', clear
  3.     describe
  4.     foreach outcome in stroke mi hf vte dm_keto depress anx {
  5.         preserve
  6.         * Drop events that occur on index date
.         drop if `outcome'_admit_date==index_date
  7. 
.         * Update study population for diabetes and respiratory outcomes
.         drop if diabetes_subgroup==0 & "`outcome'"== "dm_keto"
  8.         
.         * Cox model for each outcome category
.         * Generate flags and end dates for each outcome
.         gen `outcome'_admit=(`outcome'_admit_date!=.)
  9.         tab `outcome'_admit
 10.         count if `outcome'_admit_date!=.
 11.         if r(N) > 10 {
 12.                 gen `outcome'_end = end_date
 13.                 replace `outcome'_end = `outcome'_admit_date if `outcome'_
> admit==1
 14. 
.                 stset `outcome'_end, fail(`outcome'_admit) id(patient_id) ent
> er(index_date) origin(index_date) 
 15.                 * Kaplan-Meier plot
.                 *sts graph, by(eth5) ylabel(.99(0.01)1) title("`period'") gra
> phregion(fcolor(white))
.                 *graph export ./output/graphs/km_`outcome'_`period'.svg, as(s
> vg) replace
.                 *stcox eth5, strata(stp)
.                 *estat phtest 
.                 stcox eth5 i.age_cat i.male, strata(stp) nolog
 16.                 estat phtest, d 
 17.                 stcox eth5 i.age_cat i.male, strata(stp) tvc(i.age_cat i.m
> ale) texp(_t) nolog
 18.                 stcox eth5 i.age_cat i.male i.urban_rural_bin i.imd i.shie
> lded, strata(stp) nolog
 19.                 estat phtest
 20.                 stcox eth5 i.age_cat i.male i.urban_rural_bin i.imd i.shie
> lded, strata(stp) tvc(i.age_cat i.male i.urban_rural_bin i.imd i.shielded) te
> xp(_t)
 21.         }
 22.     restore
 23.     } 
 24. }

Contains data from ./output/prep_survival_pre.dta
  obs:         1,000                          
 vars:            46                          16 May 2023 10:11
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
self_harm_pri~n str10   %10s                  
stp             str4    %9s                   
age             int     %8.0g                 
ethnicity       byte    %8.0g                 
has_msoa        byte    %8.0g                 
imd             byte    %8.0g                 
shielded        byte    %8.0g                 
has_t1_diabetes byte    %8.0g                 
has_t2_diabetes byte    %8.0g                 
diabetes_subg~p byte    %8.0g                 
cvd_subgroup    byte    %8.0g                 
has_asthma      byte    %8.0g                 
has_copd        byte    %8.0g                 
resp_subgroup   byte    %8.0g                 
mh_subgroup     byte    %8.0g                 
urban_rural     byte    %8.0g                 
patient_id      int     %8.0g                 
dereg_dateA     float   %dD/N/CY              
mi_admit_date   float   %dD/N/CY              
stroke_admit_~e float   %dD/N/CY              
hf_admit_date   float   %dD/N/CY              
vte_admit_date  float   %dD/N/CY              
t1dm_admit_date float   %dD/N/CY              
t2dm_admit_date float   %dD/N/CY              
dm_keto_admit~e float   %dD/N/CY              
asthma_admit_~e float   %dD/N/CY              
depress_admit~e float   %dD/N/CY              
anx_admit_date  float   %dD/N/CY              
smi_admit_date  float   %dD/N/CY              
cvd_admit_date  float   %dD/N/CY              
dm_admit_date   float   %dD/N/CY              
copd_admit_date float   %dD/N/CY              
mh_admit_date   float   %dD/N/CY              
date_died       float   %dD/N/CY              
lrti_admit_date float   %dD/N/CY              
copd_any_date   float   %dD/N/CY              
lrti_copd       float   %9.0g                 
index_date      float   %dD/N/CY              
end_study       float   %dD/N/CY              
end_date        float   %dD/N/CY              
eth5            float   %11.0g     eth5       
male            float   %9.0g      male       
region          float   %24.0g     region     region of England
urban_rural_5   float   %27.0g     urban_rural_5
                                              Rural Urban in five categories
urban_rural_bin float   %9.0g      urban_rural_bin
                                              Rural-Urban
age_cat         float   %13.0g     age        
-------------------------------------------------------------------------------
Sorted by: 
(0 observations deleted)
(0 observations deleted)

stroke_admi |
          t |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        975       97.50       97.50
          1 |         25        2.50      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  25
(25 real changes made)

                id:  patient_id
     failure event:  stroke_admit != 0 & stroke_admit < .
obs. time interval:  (stroke_end[_n-1], stroke_end]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,000  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,000  observations remaining, representing
      1,000  subjects
         25  failures in single-failure-per-subject data
    742,364  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       752

         failure _d:  stroke_admit
   analysis time _t:  (stroke_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

Stratified Cox regr. -- no ties

No. of subjects =          748                  Number of obs    =          37
No. of failures =           15
Time at risk    =       557180
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |          1  (omitted)
             |
     age_cat |
41 - 60 y..  |          1  (omitted)
61 - 80 y..  |          1  (omitted)
  >80 years  |          1  (omitted)
             |
        male |
       Male  |          1  (omitted)
------------------------------------------------------------------------------
                                                             Stratified by stp

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
no observations
r(2000);

end of do-file
r(2000);

end of do-file

r(2000);


