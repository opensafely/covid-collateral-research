
. cap mkdir ./output/graphs

. cap mkdir ./output/tempdata

. cap mkdir ./output/tables

. 
. * open file to write results to
. file open tablecontent using ./output/tables/`outcome'_cox_models.txt, write 
> text replace
(note: file ./output/tables/t1dm_cox_models.txt not found)

. file write tablecontent ("Period") _tab ("Ethnic group") _tab ("Denominator")
>  _tab ("Events") _tab ("Total person-weeks") _tab ("Rate per 1000") _tab ("Cr
> ude HR") _tab _tab ("Age/Sex Adjusted") _tab _tab ("Fully Adjusted") _tab _ta
> b  _n

. file write tablecontent _tab _tab _tab _tab _tab _tab   ("HR") _tab ("95% CI"
> ) _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ("95% CI") _tab _tab  _n

. 
. foreach period in pre pandemic wave1 easing1 wave2 easing2 wave3 easing3 {
  2. use ./output/prep_survival_`period', clear
  3. 
.     * Drop events that occur on index date
.     drop if `outcome'_admit_date==index_date
  4.     * Cox model for each outcome category
.     * Generate flags and end dates for each outcome
.     gen `outcome'_admit=(`outcome'_admit_date!=.)
  5.     tab `outcome'_admit
  6.     count if `outcome'_admit_date!=.
  7.     if r(N) > 10 {
  8.         gen `outcome'_end = end_date
  9.         replace `outcome'_end = `outcome'_admit_date if `outcome'_admit==1
 10. 
.         stset `outcome'_end, fail(`outcome'_admit) id(patient_id) enter(index
> _date) origin(index_date) 
 11.         * Kaplan-Meier plot
.         sts graph, by(eth5) ylabel(.75(.05)1)
 12.         graph export ./output/graphs/km_`outcome'_`period'_eth.svg, as(svg
> ) replace
 13.         * Cox model - crude
.         stcox i.eth5, strata(stp)
 14.         estimates save "./output/tempdata/crude_`outcome'_eth", replace 
 15.         eststo model1
 16.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_crude_`outcome'_eth", replace) idstr("crude_`outcome'_eth") 
 17.         *estat phtest, detail
.         * Cox model - age and gender adjusted
.         stcox i.eth5 i.age_cat i.male, strata(stp)
 18.         estimates save "./output/tempdata/model1_`outcome'_eth", replace 
 19.         eststo model2
 20.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_model1_`outcome'_eth", replace) idstr("model1_`outcome'_eth") 
 21.         *estat phtest, detail
.         * Cox model - fully adjusted
.         stcox i.eth5 i.age_cat i.male i.urban_rural_bin i.imd i.shielded, str
> ata(stp)
 22.         estimates save "./output/tempdata/model2_`outcome'_eth", replace 
 23.         eststo model3
 24.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_model2_`outcome'_eth", replace) idstr("model2_`outcome'_eth") 
 25.         *estat phtest, detail
.         esttab model1 model2 model3 using "./output/tables/`outcome'_estout_t
> able_eth_`period'.txt", b(a2) ci(2) label wide compress eform ///
>         title ("`outcome'") ///
>         varlabels(`e(labels)') ///
>         stats(N_outcome) ///
>         append 
 26.         eststo clear
 27.     * Write results to table
.         * eth16 labelled columns
. 
.         local lab1: label eth5 1
 28.         local lab2: label eth5 2
 29.         local lab3: label eth5 3
 30.         local lab4: label eth5 4
 31.         local lab5: label eth5 5
 32.         /* counts */
.         
.         * First row, eth16 = 1 (White British) reference cat
.         qui safecount if eth5==1
 33.         local denominator = r(N)
 34.         qui safecount if eth5 == 1 & `outcome'_admit == 1
 35.         local event = r(N)
 36.         bysort eth5: egen total_follow_up = total(_t)
 37.         qui su total_follow_up if eth5 == 1
 38.         local person_week = r(mean)/7
 39.         local rate = 100000*(`event'/`person_week')
 40.         if `event'>10 & `event'!=. {
 41.             file write tablecontent  ("`period'") _tab ("`lab1'") _tab (`d
> enominator') _tab (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _
> tab
 42.             file write tablecontent ("1.00") _tab _tab ("1.00") _tab _tab 
> ("1.00") _n
 43.             }
 44.         else {
 45.             file write tablecontent ("`period'") _tab ("`lab`eth''") _tab 
> ("redact") _n
 46.             continue
 47.         }
 48.     * outcomesequent ethnic groups
.         forvalues eth=2/5 {
 49.             qui safecount if eth5==`eth'
 50.             local denominator = r(N)
 51.             qui safecount if eth5 == `eth' & `outcome'_admit == 1
 52.             local event = r(N)
 53.             qui su total_follow_up if eth5 == `eth'
 54.             local person_week = r(mean)/7
 55.             local rate = 100000*(`event'/`person_week')
 56.             if `event'>10 & `event'!=. {
 57.                 file write tablecontent ("`period'") _tab ("`lab`eth''") _
> tab (`denominator') _tab (`event') _tab %10.0f (`person_week') _tab %3.2f (`r
> ate') _tab  
 58.                 cap estimates use "./output/tempdata/crude_`outcome'_eth" 
 59.                 cap lincom `eth'.eth5, eform
 60.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab 
 61.                 cap estimates clear
 62.                 cap estimates use "./output/tempdata/model1_`outcome'_eth"
>  
 63.                 cap lincom `eth'.eth5, eform
 64.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab 
 65.                 cap estimates clear
 66.                 cap estimates use "./output/tempdata/model2_`outcome'_eth"
>  
 67.                 cap lincom `eth'.eth5, eform
 68.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab _n
 69.                 cap estimates clear
 70.             }
 71.             else {
 72.                 file write tablecontent ("`period'") _tab ("`lab`eth''") _
> tab ("redact") _n
 73.                 continue
 74.             }
 75.         }  //end ethnic group
 76. drop total_follow_up
 77.     }
 78. else { 
 79.     file write tablecontent ("`period'") _tab ("redact") _n
 80.     continue
 81. }
 82. } //end outcomes
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        982       98.20       98.20
          1 |         18        1.80      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  18
(18 real changes made)

                id:  patient_id
     failure event:  t1dm_admit != 0 & t1dm_admit < .
obs. time interval:  (t1dm_end[_n-1], t1dm_end]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,000  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,000  observations remaining, representing
      1,000  subjects
         18  failures in single-failure-per-subject data
    744,921  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       752

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id
(note: file ./output/graphs/km_t1dm_pre_eth.svg not found)
(file ./output/graphs/km_t1dm_pre_eth.svg written in SVG format)

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

Iteration 0:   log likelihood = -2.1972246
Iteration 1:   log likelihood = -1.1935352
Iteration 2:   log likelihood = -1.1312338
Iteration 3:   log likelihood =  -1.110344
Iteration 4:   log likelihood = -1.1028935
Iteration 5:   log likelihood = -1.1001826
Iteration 6:   log likelihood = -1.0991894
Iteration 7:   log likelihood = -1.0988245
Iteration 8:   log likelihood = -1.0986903
Iteration 9:   log likelihood =  -1.098641
Iteration 10:  log likelihood = -1.0986229
Iteration 11:  log likelihood = -1.0986162
Iteration 12:  log likelihood = -1.0986137
Iteration 13:  log likelihood = -1.0986128
Iteration 14:  log likelihood = -1.0986125
Iteration 15:  log likelihood = -1.0986124
Iteration 16:  log likelihood = -1.0986123
Iteration 17:  log likelihood = -1.0986123
Iteration 18:  log likelihood = -1.0986123
Iteration 19:  log likelihood = -1.0986123
Iteration 20:  log likelihood = -1.0986123
Iteration 21:  log likelihood = -1.0986123
Iteration 22:  log likelihood = -1.0986123
Iteration 23:  log likelihood = -1.0986123
Iteration 24:  log likelihood = -1.0986123
Iteration 25:  log likelihood = -1.0986123
Iteration 26:  log likelihood = -1.0986123
Iteration 27:  log likelihood = -1.0986123
Iteration 28:  log likelihood = -1.0986123
Iteration 29:  log likelihood = -1.0986123
Iteration 30:  log likelihood = -1.0986123
Iteration 31:  log likelihood = -1.0986123
Iteration 32:  log likelihood = -1.0986123
Refining estimates:
Iteration 0:   log likelihood = -1.0986123
Iteration 1:   log likelihood = -1.0986123
Iteration 2:   log likelihood = -1.0986123

Stratified Cox regr. -- no ties

No. of subjects =        1,000                  Number of obs    =          50
No. of failures =           18
Time at risk    =       744921
                                                LR chi2(4)       =        2.20
Log likelihood  =   -1.0986123                  Prob > chi2      =      0.6995

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |          1   1.55e+08    -0.00   1.000            0           .
      Black  |          1   1.18e+08    -0.00   1.000            0           .
      Mixed  |          1   1.55e+08    -0.00   1.000            0           .
      Other  |   5.02e+15   4.74e+23     0.00   1.000            0           .
------------------------------------------------------------------------------
                                                             Stratified by stp
(note: file ./output/tempdata/crude_t1dm_eth.ster not found)
file ./output/tempdata/crude_t1dm_eth.ster saved
(note: file ./output/tempdata/surv_crude_t1dm_eth.dta not found)
file ./output/tempdata/surv_crude_t1dm_eth.dta saved

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

note: 3.age_cat omitted because of collinearity
Iteration 0:   log likelihood =          0
Refining estimates:
Iteration 0:   log likelihood =          0

Stratified Cox regr. -- no ties

No. of subjects =          784                  Number of obs    =          40
No. of failures =           13
Time at risk    =       583931
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |          1  (omitted)
      Black  |          1  (omitted)
      Mixed  |          1  (omitted)
      Other  |          1  (omitted)
             |
     age_cat |
41 - 60 y..  |          1  (omitted)
61 - 80 y..  |          1  (omitted)
  >80 years  |          1  (omitted)
             |
        male |
       Male  |          1  (omitted)
------------------------------------------------------------------------------
                                                             Stratified by stp
(note: file ./output/tempdata/model1_t1dm_eth.ster not found)
file ./output/tempdata/model1_t1dm_eth.ster saved
(note: file ./output/tempdata/surv_model1_t1dm_eth.dta not found)
file ./output/tempdata/surv_model1_t1dm_eth.dta saved

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

note: 3.age_cat omitted because of collinearity
Iteration 0:   log likelihood =          0
Refining estimates:
Iteration 0:   log likelihood =          0

Stratified Cox regr. -- no ties

No. of subjects =          784                  Number of obs    =          40
No. of failures =           13
Time at risk    =       583931
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |          1  (omitted)
      Black  |          1  (omitted)
      Mixed  |          1  (omitted)
      Other  |          1  (omitted)
             |
     age_cat |
41 - 60 y..  |          1  (omitted)
61 - 80 y..  |          1  (omitted)
  >80 years  |          1  (omitted)
             |
        male |
       Male  |          1  (omitted)
             |
urban_rura~n |
      Urban  |          1  (omitted)
             |
         imd |
          1  |          1  (omitted)
          2  |          1  (omitted)
          3  |          1  (omitted)
          4  |          1  (omitted)
          5  |          1  (omitted)
             |
  1.shielded |          1  (omitted)
------------------------------------------------------------------------------
                                                             Stratified by stp
(note: file ./output/tempdata/model2_t1dm_eth.ster not found)
file ./output/tempdata/model2_t1dm_eth.ster saved
(note: file ./output/tempdata/surv_model2_t1dm_eth.dta not found)
file ./output/tempdata/surv_model2_t1dm_eth.dta saved
(note: file ./output/tables/t1dm_estout_table_eth_pre.txt not found)
(output written to ./output/tables/t1dm_estout_table_eth_pre.txt)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        974       97.40       97.40
          1 |         26        2.60      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  26
(26 real changes made)

                id:  patient_id
     failure event:  t1dm_admit != 0 & t1dm_admit < .
obs. time interval:  (t1dm_end[_n-1], t1dm_end]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,000  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,000  observations remaining, representing
      1,000  subjects
         26  failures in single-failure-per-subject data
    722,352  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       768

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id
(note: file ./output/graphs/km_t1dm_pandemic_eth.svg not found)
(file ./output/graphs/km_t1dm_pandemic_eth.svg written in SVG format)

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

Iteration 0:   log likelihood = -2.1972246
Iteration 1:   log likelihood = -1.1935352
Iteration 2:   log likelihood = -1.1312338
Iteration 3:   log likelihood =  -1.110344
Iteration 4:   log likelihood = -1.1028935
Iteration 5:   log likelihood = -1.1001826
Iteration 6:   log likelihood = -1.0991894
Iteration 7:   log likelihood = -1.0988245
Iteration 8:   log likelihood = -1.0986903
Iteration 9:   log likelihood =  -1.098641
Iteration 10:  log likelihood = -1.0986229
Iteration 11:  log likelihood = -1.0986162
Iteration 12:  log likelihood = -1.0986137
Iteration 13:  log likelihood = -1.0986128
Iteration 14:  log likelihood = -1.0986125
Iteration 15:  log likelihood = -1.0986124
Iteration 16:  log likelihood = -1.0986123
Iteration 17:  log likelihood = -1.0986123
Iteration 18:  log likelihood = -1.0986123
Iteration 19:  log likelihood = -1.0986123
Iteration 20:  log likelihood = -1.0986123
Iteration 21:  log likelihood = -1.0986123
Iteration 22:  log likelihood = -1.0986123
Iteration 23:  log likelihood = -1.0986123
Iteration 24:  log likelihood = -1.0986123
Iteration 25:  log likelihood = -1.0986123
Iteration 26:  log likelihood = -1.0986123
Iteration 27:  log likelihood = -1.0986123
Iteration 28:  log likelihood = -1.0986123
Iteration 29:  log likelihood = -1.0986123
Iteration 30:  log likelihood = -1.0986123
Iteration 31:  log likelihood = -1.0986123
Iteration 32:  log likelihood = -1.0986123
Refining estimates:
Iteration 0:   log likelihood = -1.0986123
Iteration 1:   log likelihood = -1.0986123
Iteration 2:   log likelihood = -1.0986123

Stratified Cox regr. -- no ties

No. of subjects =        1,000                  Number of obs    =          50
No. of failures =           26
Time at risk    =       722352
                                                LR chi2(4)       =        2.20
Log likelihood  =   -1.0986123                  Prob > chi2      =      0.6995

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |   .9993712   1.61e+08    -0.00   1.000            0           .
      Black  |   .9993713   1.93e+08    -0.00   1.000            0           .
      Mixed  |   .9993712   1.93e+08    -0.00   1.000            0           .
      Other  |   5.01e+15   7.45e+23     0.00   1.000            0           .
------------------------------------------------------------------------------
                                                             Stratified by stp
file ./output/tempdata/crude_t1dm_eth.ster saved
file ./output/tempdata/surv_crude_t1dm_eth.dta saved

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

Iteration 0:   log likelihood =          0
Refining estimates:
Iteration 0:   log likelihood =          0

Stratified Cox regr. -- no ties

No. of subjects =          786                  Number of obs    =          42
No. of failures =           14
Time at risk    =       569832
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |          1  (omitted)
      Black  |          1  (omitted)
      Mixed  |          1  (omitted)
      Other  |          1  (omitted)
             |
     age_cat |
41 - 60 y..  |          1  (omitted)
61 - 80 y..  |          1  (omitted)
  >80 years  |          1  (omitted)
             |
        male |
       Male  |          1  (omitted)
------------------------------------------------------------------------------
                                                             Stratified by stp
file ./output/tempdata/model1_t1dm_eth.ster saved
file ./output/tempdata/surv_model1_t1dm_eth.dta saved

         failure _d:  t1dm_admit
   analysis time _t:  (t1dm_end-origin)
             origin:  time index_date
  enter on or after:  time index_date
                 id:  patient_id

Iteration 0:   log likelihood =          0
Refining estimates:
Iteration 0:   log likelihood =          0

Stratified Cox regr. -- no ties

No. of subjects =          786                  Number of obs    =          42
No. of failures =           14
Time at risk    =       569832
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

------------------------------------------------------------------------------
          _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        eth5 |
South Asian  |          1  (omitted)
      Black  |          1  (omitted)
      Mixed  |          1  (omitted)
      Other  |          1  (omitted)
             |
     age_cat |
41 - 60 y..  |          1  (omitted)
61 - 80 y..  |          1  (omitted)
  >80 years  |          1  (omitted)
             |
        male |
       Male  |          1  (omitted)
             |
urban_rura~n |
      Urban  |          1  (omitted)
             |
         imd |
          1  |          1  (omitted)
          2  |          1  (omitted)
          3  |          1  (omitted)
          4  |          1  (omitted)
          5  |          1  (omitted)
             |
  1.shielded |          1  (omitted)
------------------------------------------------------------------------------
                                                             Stratified by stp
file ./output/tempdata/model2_t1dm_eth.ster saved
file ./output/tempdata/surv_model2_t1dm_eth.dta saved
(note: file ./output/tables/t1dm_estout_table_eth_pandemic.txt not found)
(output written to ./output/tables/t1dm_estout_table_eth_pandemic.txt)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        997       99.70       99.70
          1 |          3        0.30      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  3
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        996       99.60       99.60
          1 |          4        0.40      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  4
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        993       99.30       99.30
          1 |          7        0.70      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  7
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,000      100.00      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  0
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        992       99.20       99.20
          1 |          8        0.80      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  8
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        994       99.40       99.40
          1 |          6        0.60      100.00
------------+-----------------------------------
      Total |      1,000      100.00
  6

. file close tablecontent

. 
. log close
      name:  <unnamed>
       log:  /workspace/logs/cox_model_t1dm.log
  log type:  text
 closed on:  14 Jul 2022, 15:14:00
-------------------------------------------------------------------------------
