
. cap mkdir ./output/graphs

. cap mkdir ./output/tempdata

. cap mkdir ./output/tables

. 
. di "`outcome'"
t1dm

. 
. * open file to write results to
. file open tablecontent using ./output/tables/`outcome'_cox_models.txt, write 
> text replace
(note: file ./output/tables/t1dm_cox_models.txt not found)

. file write tablecontent ("period") _tab ("ethnic_group") _tab ("denominator")
>  _tab ("events") _tab ("total_person_wks") _tab ("Rate") _tab ("unadj_hr") _t
> ab ///
> ("unadj_ci") _tab ("unadj_lci") _tab ("unadj_uci") _tab ("p_adj_hr") _tab ("p
> _adj_ci") _tab ("p_adj_lci") _tab ("p_adj_uci") _tab ("f_adj_hr") _tab ("f_ad
> j_ci") _tab ("f_adj_lci") _tab ("f_adj_uci") _tab  _n

. 
. foreach period in pre pandemic wave1 easing1 wave2 easing2 wave3 easing3 {
  2. use ./output/prep_survival_`period', clear
  3. 
.     * Drop events that occur on index date
.     drop if `outcome'_admit_date==index_date
  4. 
.     * Update study population for diabetes and respiratory outcomes
.     drop if has_t1_diabetes==0 & "`outcome'"=="t1dm"
  5.     drop if has_t2_diabetes==0 & "`outcome'"=="t2dm"
  6.     drop if diabetes_subgroup==0 & "`outcome'"=="dm_keto"
  7.     drop if has_asthma==0 & "`outcome'"=="asthma"
  8.     drop if has_copd==1 & "`outcome'"=="copd"
  9. 
.     * Cox model for each outcome category
.     * Generate flags and end dates for each outcome
.     gen `outcome'_admit=(`outcome'_admit_date!=.)
 10.     tab `outcome'_admit
 11.     count if `outcome'_admit_date!=.
 12.     if r(N) > 10 {
 13.         gen `outcome'_end = end_date
 14.         replace `outcome'_end = `outcome'_admit_date if `outcome'_admit==1
 15. 
.         stset `outcome'_end, fail(`outcome'_admit) id(patient_id) enter(index
> _date) origin(index_date) 
 16.         * Kaplan-Meier plot
.         sts graph, by(eth5) ylabel(.75(.05)1)
 17.         graph export ./output/graphs/km_`outcome'_`period'_eth.svg, as(svg
> ) replace
 18.         * Cox model - crude
.         stcox i.eth5, strata(stp)
 19.         estimates save "./output/tempdata/crude_`outcome'_eth", replace 
 20.         eststo model1
 21.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_crude_`outcome'_eth", replace) idstr("crude_`outcome'_eth") 
 22.         *estat phtest, detail
.         * Cox model - age and gender adjusted
.         stcox i.eth5 i.age_cat i.male, strata(stp)
 23.         estimates save "./output/tempdata/model1_`outcome'_eth", replace 
 24.         eststo model2
 25.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_model1_`outcome'_eth", replace) idstr("model1_`outcome'_eth") 
 26.         *estat phtest, detail
.         * Cox model - fully adjusted
.         stcox i.eth5 i.age_cat i.male i.urban_rural_bin i.imd i.shielded, str
> ata(stp)
 27.         estimates save "./output/tempdata/model2_`outcome'_eth", replace 
 28.         eststo model3
 29.         parmest, label eform format(estimate p lb ub) saving("./output/tem
> pdata/surv_model2_`outcome'_eth", replace) idstr("model2_`outcome'_eth") 
 30.         *estat phtest, detail
.         esttab model1 model2 model3 using "./output/tables/`outcome'_estout_t
> able_eth_`period'.txt", b(a2) ci(2) label wide compress eform ///
>         title ("`outcome'") ///
>         varlabels(`e(labels)') ///
>         stats(N_outcome) ///
>         append 
 31.         eststo clear
 32.     * Write results to table
.         * eth16 labelled columns
. 
.         local lab1: label eth5 1
 33.         local lab2: label eth5 2
 34.         local lab3: label eth5 3
 35.         local lab4: label eth5 4
 36.         local lab5: label eth5 5
 37.         /* counts */
.         
.         * First row, eth16 = 1 (White British) reference cat
.         qui safecount if eth5==1
 38.         local denominator = r(N)
 39.         qui safecount if eth5 == 1 & `outcome'_admit == 1
 40.         local event = r(N)
 41.         bysort eth5: egen total_follow_up = total(_t)
 42.         qui su total_follow_up if eth5 == 1
 43.         local person_mth = r(mean)/30
 44.         local rate = 100000*(`event'/`person_mth')
 45.         if `event'>10 & `event'!=. {
 46.             file write tablecontent  ("`period'") _tab ("`lab1'") _tab (`d
> enominator') _tab (`event') _tab %10.0f (`person_mth') _tab %3.2f (`rate') _t
> ab
 47.             file write tablecontent ("1.00") _tab _tab ("1.00") _tab _tab 
> _tab _tab ("1.00") _n
 48.             }
 49.         else {
 50.             file write tablecontent ("`period'") _tab ("`lab`eth''") _tab 
> ("redact") _n
 51.             continue
 52.         }
 53.     * outcomesequent ethnic groups
.         forvalues eth=2/5 {
 54.             qui safecount if eth5==`eth'
 55.             local denominator = r(N)
 56.             qui safecount if eth5 == `eth' & `outcome'_admit == 1
 57.             local event = r(N)
 58.             qui su total_follow_up if eth5 == `eth'
 59.             local person_mth = r(mean)/30
 60.             local rate = 100000*(`event'/`person_mth')
 61.             if `event'>10 & `event'!=. {
 62.                 file write tablecontent ("`period'") _tab ("`lab`eth''") _
> tab (`denominator') _tab (`event') _tab %10.0f (`person_mth') _tab %3.2f (`ra
> te') _tab  
 63.                 cap estimates use "./output/tempdata/crude_`outcome'_eth" 
 64.                 cap lincom `eth'.eth5, eform
 65.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab %4.2f (r(lb)) _tab %4.2f (r(ub))
>  _tab
 66.                 cap estimates clear
 67.                 cap estimates use "./output/tempdata/model1_`outcome'_eth"
>  
 68.                 cap lincom `eth'.eth5, eform
 69.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab %4.2f (r(lb)) _tab %4.2f (r(ub))
>   _tab
 70.                 cap estimates clear
 71.                 cap estimates use "./output/tempdata/model2_`outcome'_eth"
>  
 72.                 cap lincom `eth'.eth5, eform
 73.                 file write tablecontent  %4.2f (r(estimate)) _tab ("(") %4
> .2f (r(lb)) (" - ") %4.2f (r(ub)) (")") _tab %4.2f (r(lb)) _tab %4.2f (r(ub))
>  _n
 74.                 cap estimates clear
 75.             }
 76.             else {
 77.                 file write tablecontent ("`period'") _tab ("`lab`eth''") _
> tab ("redact") _n
 78.                 continue
 79.             }
 80.         }  //end ethnic group
 81. drop total_follow_up
 82.     }
 83. else { 
 84.     file write tablecontent ("`period'") _tab ("redact") _n
 85.     continue
 86. }
 87. } //end outcomes
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        192       96.00       96.00
          1 |          8        4.00      100.00
------------+-----------------------------------
      Total |        200      100.00
  8
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        193       96.50       96.50
          1 |          7        3.50      100.00
------------+-----------------------------------
      Total |        200      100.00
  7
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        198       99.00       99.00
          1 |          2        1.00      100.00
------------+-----------------------------------
      Total |        200      100.00
  2
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        200      100.00      100.00
------------+-----------------------------------
      Total |        200      100.00
  0
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        199       99.50       99.50
          1 |          1        0.50      100.00
------------+-----------------------------------
      Total |        200      100.00
  1
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        200      100.00      100.00
------------+-----------------------------------
      Total |        200      100.00
  0
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        200      100.00      100.00
------------+-----------------------------------
      Total |        200      100.00
  0
(0 observations deleted)
(800 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)
(0 observations deleted)

 t1dm_admit |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        199       99.50       99.50
          1 |          1        0.50      100.00
------------+-----------------------------------
      Total |        200      100.00
  1

. file close tablecontent

. 
. log close
      name:  <unnamed>
       log:  /workspace/logs/cox_model_t1dm.log
  log type:  text
 closed on:   9 Aug 2022, 13:00:04
-------------------------------------------------------------------------------
